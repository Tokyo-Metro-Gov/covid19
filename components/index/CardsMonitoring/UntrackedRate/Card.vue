<template>
  <v-col cols="12" :md="isSingleCard || 6" class="DataCard UntrackedRateCard">
    <client-only>
      <chart
        :title-id="'untracked-rate'"
        :info-titles="[$t('新規陽性者における接触歴等不明者数'), $t('増加比')]"
        :chart-id="'untracked-rate-chart'"
        :chart-data="chartData"
        :date="date"
        :labels="labels"
        :units="units"
        :data-labels="dataLabels"
        :table-labels="tableLabels"
        :get-formatter="getFormatter"
        :day-period="isSingleCard ? 120 : 60"
        :is-single-card="isSingleCard"
        url="https://catalog.data.metro.tokyo.lg.jp/dataset/t000001d0000000010"
      >
        <template #attentionNote>
          {{
            $t(
              '「新規陽性者における接触歴等不明者」 は、全数届出の見直しにより、 2022年9月26日(月曜日)分をもって更新を終了しました。'
            )
          }}
        </template>
        <template #additionalDescription>
          <span>{{ $t('（注）') }}</span>
          <ul>
            <li>
              {{
                $t(
                  '保健所から発生届が提出された日別（報告日別）の新規陽性者について、接触歴等の不明者、判明者に区分したものである'
                )
              }}
            </li>
            <li>
              {{
                $t(
                  '集団感染発生や曜日による数値のばらつきにより、日々の結果が変動するため、こうしたばらつきを平準化し全体の傾向を見る趣旨から、過去7日間の移動平均値を不明者数として算出（例えば、2020年5月7日の移動平均値は、2020年5月1日から5月7日までの実績値を平均したもの）'
                )
              }}
            </li>
            <li>
              {{
                $t(
                  '濃厚接触者など、患者の発生状況の内訳の公表を開始した2020年3月27日から作成'
                )
              }}
            </li>
            <li>
              {{
                $t('増加比は、１週間前の接触歴等不明者数（移動平均値）との比較')
              }}
            </li>
            <li>
              {{
                $t(
                  '2022年2月2日以降は、感染者の濃厚接触者が有症状となった場合で、検査を実施せずに医師の判断により臨床診断された患者を含む'
                )
              }}
            </li>
          </ul>
        </template>
      </chart>
    </client-only>
  </v-col>
</template>

<script lang="ts">
import Vue from 'vue'

import Chart from '@/components/index/CardsMonitoring/UntrackedRate/Chart.vue'
import {
  DailyPositiveDetail as IDailyPositiveDetail,
  Datum as IDailyPositiveDetailDatum,
} from '@/libraries/auto_generated/data_converter/convertDailyPositiveDetail'
import {
  getNumberToFixedFunction,
  getNumberToLocaleStringFunction,
} from '@/utils/monitoringStatusValueFormatters'
import { isSingleCard } from '@/utils/urls'

type Data = {
  dataLabels: string[]
  tableLabels: string[]
  getFormatter: (columnIndex: number) => (d: number) => string | undefined
  units: string[]
}
type Methods = {}
type Computed = {
  chartData: (number | null)[][]
  date: string
  labels: string[]
  filteredDailyPositiveDetailData: IDailyPositiveDetailDatum[]
  dailyPositiveDetail: IDailyPositiveDetail
  isSingleCard: boolean
}
type Props = {}

const firstDiagnosedDate = new Date('2020-03-27')
const lastDiagnosedDate = new Date('2022-09-26')

export default Vue.extend<Data, Methods, Computed, Props>({
  components: {
    Chart,
  },
  data() {
    const dataLabels = [
      this.$t('接触歴等判明者数') as string,
      this.$t('接触歴等不明者数') as string,
      this.$t('接触歴等不明者数（７日間移動平均）') as string,
      this.$t('増加比') as string,
    ]

    const tableLabels = [
      this.$t('接触歴等判明者数') as string,
      this.$t('接触歴等不明者数') as string,
      this.$t('接触歴等不明者数（７日間移動平均）') as string,
      this.$t('増加比') as string,
    ]

    const getFormatter = (columnIndex: number) => {
      // 7日間移動平均と増加比は小数点第1位まで表示する。
      if (columnIndex >= 2) {
        return getNumberToFixedFunction(1)
      }
      return getNumberToLocaleStringFunction()
    }

    const units = [this.$t('人') as string, '%', this.$t('ポイント') as string]

    return {
      dataLabels,
      tableLabels,
      getFormatter,
      units,
    }
  },
  computed: {
    chartData() {
      const reportedCount: (number | null)[] =
        this.filteredDailyPositiveDetailData.map((d) => d.reportedCount)

      const missingCount: (number | null)[] =
        this.filteredDailyPositiveDetailData.map((d) => d.missingCount)

      const untrackedRate: (number | null)[] =
        this.filteredDailyPositiveDetailData.map(
          (d) => d.weeklyAverageUntrackedCount
        )

      const untrackedIncreseRate: (number | null)[] =
        this.filteredDailyPositiveDetailData.map(
          (d) => d.weeklyAverageUntrackedIncresePercent
        )

      return [reportedCount, missingCount, untrackedRate, untrackedIncreseRate]
    },
    date() {
      return this.dailyPositiveDetail.date
    },
    labels() {
      return this.filteredDailyPositiveDetailData.map(
        (d) => `${d.diagnosedDate}`
      )
    },
    filteredDailyPositiveDetailData() {
      return this.dailyPositiveDetail.data.filter((d) => {
        const diagnosedDate = new Date(d.diagnosedDate)
        return (
          diagnosedDate >= firstDiagnosedDate &&
          diagnosedDate <= lastDiagnosedDate
        )
      })
    },
    dailyPositiveDetail() {
      return this.$store.state.dailyPositiveDetail
    },
    isSingleCard() {
      return isSingleCard(this.$route.path)
    },
  },
})
</script>
